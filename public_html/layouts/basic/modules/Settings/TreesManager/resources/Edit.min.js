'use strict';

jQuery.Class('Settings_TreesManager_Edit_Js',{},{jstreeInstance:!1,jstreeLastID:0,registerEvents:function registerEvents(){var thisInstance=this,editContainer=$('#EditView'),jstreeInstance=thisInstance.createTree();editContainer.validationEngine(),$('.addNewElementBtn').on('click',function(){var newElement=$('input.addNewElement'),ref=jstreeInstance.jstree(!0);if(''===newElement.val()){var message=app.vtranslate('JS_FIELD_CAN_NOT_BE_EMPTY');return newElement.validationEngine('showPrompt',message,'error','bottomLeft',!0),!1}thisInstance.jstreeLastID+=1,ref.create_node('#',{id:thisInstance.jstreeLastID,text:newElement.val(),icon:!1},'last'),newElement.val('');}),$('.saveTree').on('click',function(){jstreeInstance.jstree('deselect_all',!0);var json=jstreeInstance.jstree('get_json'),forSave=[];$.each(json,function(index,value){value.text==value.li_attr.text&&(value.text=value.li_attr.key),forSave[index]=value;}),$('#treeValues').val(JSON.stringify(forSave)),editContainer.submit();}),$('.addNewElement').on('keydown',function(event){if(13==event.keyCode)return $('.addNewElementBtn').trigger('click'),event.preventDefault(),!1});},createTree:function createTree(){var thisInstance=this;if(!1==this.jstreeInstance){thisInstance.jstreeLastID=parseInt($('#treeLastID').val());var treeValues=$('#treeValues').val(),data=JSON.parse(treeValues);thisInstance.jstreeInstance=$('#treeContents'),thisInstance.jstreeInstance.jstree({core:{data:data,themes:{name:'proton',responsive:!0},check_callback:!0},contextmenu:{items:{create:{label:app.vtranslate('JS_JSTREE_CREATE'),action:function action(data){var inst=$.jstree.reference(data.reference);obj=inst.get_node(data.reference),++thisInstance.jstreeLastID,inst.create_node(obj,{id:thisInstance.jstreeLastID,text:app.vtranslate('JS_NEW_ITEM')},'last',function(new_node){setTimeout(function(){inst.edit(new_node);},0);});}},rename:{label:app.vtranslate('JS_JSTREE_RENAME'),action:function action(data){var inst=$.jstree.reference(data.reference),obj=inst.get_node(data.reference);inst.edit(obj);}},changeIcon:{label:app.vtranslate('JS_JSTREE_CHANGE_ICON'),action:function action(data){var instanceTree=$.jstree.reference(data.reference),node=instanceTree.get_node(data.reference);Settings_Vtiger_Index_Js.selectIcon().done(function(data){'-'==data.name?thisInstance.jstreeInstance.jstree(!0).set_icon(node.id,!1):thisInstance.jstreeInstance.jstree(!0).set_icon(node.id,data.name);});}},remove:{label:app.vtranslate('JS_JSTREE_REMOVE'),action:function action(data){var inst=$.jstree.reference(data.reference),id=inst.get_selected(),status=!0;$.each(id,function(index,value){var menu=inst.get_node(value);0<menu.children.length&&(Settings_Vtiger_Index_Js.showMessage({text:app.vtranslate('JS_YOU_CANNOT_DELETE_PERENT_ITEM'),type:'error'}),status=!1);}),status&&thisInstance.deleteItemEvent(id,inst).done(function(e){0<e.length&&$.each(id,function(index,value){inst.delete_node(value);});});}},ccp:{label:app.vtranslate('JS_JSTREE_CCP'),submenu:{cut:{label:app.vtranslate('JS_JSTREE_CUT'),action:function action(data){var inst=$.jstree.reference(data.reference),obj=inst.get_node(data.reference);inst.is_selected(obj)?inst.cut(inst.get_top_selected()):inst.cut(obj);}},paste:{label:app.vtranslate('JS_JSTREE_PASTE'),action:function action(data){var inst=$.jstree.reference(data.reference),obj=inst.get_node(data.reference);inst.paste(obj);}}}}}},plugins:['contextmenu','dnd']});}return this.jstreeInstance},deleteItemEvent:function deleteItemEvent(id,inst){var thisInstance=this,aDeferred=jQuery.Deferred(),data=inst.get_json();return ($.each(id,function(index,id){data=thisInstance.checkChildren(id,data);}),0==data.length)?(Settings_Vtiger_Index_Js.showMessage({text:app.vtranslate('JS_YOU_CANNOT_DELETE_ALL_THE_ITEMS'),type:'error'}),aDeferred.resolve(),aDeferred.promise()):(app.showModalWindow(null,'index.php?module=TreesManager&parent=Settings&view=ReplaceTreeItem',function(wizardContainer){var form=jQuery('form',wizardContainer),jstreeInstanceReplace=wizardContainer.find('#treePopupContents');jstreeInstanceReplace.jstree({core:{data:data,themes:{name:'proton',responsive:!0}}}).on('loaded.jstree',function(){$(this).jstree('open_all');}),form.on('submit',function(){var data,selected=jstreeInstanceReplace.jstree('get_selected'),replaceIdsElement=$('#replaceIds'),replaceIds=replaceIdsElement.val();return (data=''===replaceIds?[]:JSON.parse(replaceIds),!selected.length)?(Settings_Vtiger_Index_Js.showMessage({type:'error',text:app.vtranslate('JS_NO_ITEM_SELECTED')}),!1):1<selected.length?(Settings_Vtiger_Index_Js.showMessage({type:'error',text:app.vtranslate('JS_ONLY_ONE_ITEM_SELECTED')}),!1):void(data=$.merge(data,[{old:id,new:selected}]),replaceIdsElement.val(JSON.stringify(data)),app.hideModalWindow(),aDeferred.resolve(selected))});}),aDeferred.promise())},checkChildren:function checkChildren(id,data){var thisInstance=this,dataNew=[];for(var key in data)data[key].id!=id&&(data[key].children.length&&(data[key].children=thisInstance.checkChildren(id,data[key].children)),dataNew.push(data[key]));return dataNew}});
//# sourceMappingURL=Edit.min.js.map
